import oracledb
# D√ºzeltme Burasƒ±: Artƒ±k tam adresi veriyoruz (app.database...)
from app.database.oracle_client import get_db_connection

def create_tables():
    conn = get_db_connection()
    if not conn:
        print("‚ùå Veritabanƒ±na baƒülanƒ±lamadƒ±, i≈ülem iptal.")
        return

    cursor = conn.cursor()
    print("üî® Tablolar hazƒ±rlanƒ±yor...")

    # --- 1. USERS TABLOSU ---
    try:
        cursor.execute("""
            CREATE TABLE USERS (
                id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                username VARCHAR2(50) NOT NULL UNIQUE,
                password_hash VARCHAR2(255) NOT NULL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        """)
        print("‚úÖ USERS tablosu olu≈üturuldu.")
    except Exception as e:
        # ORA-00955: name is already used by an existing object
        if "ORA-00955" in str(e):
            print("‚ÑπÔ∏è USERS tablosu zaten var.")
        else:
            print(f"‚ùå USERS Hatasƒ±: {e}")

    # --- 2. ANALYSIS_RESULTS TABLOSU ---
    try:
        cursor.execute("""
            CREATE TABLE ANALYSIS_RESULTS (
                id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                user_id NUMBER NOT NULL,
                video_path VARCHAR2(255),
                audio_path VARCHAR2(255),
                analysis_data CLOB,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                CONSTRAINT fk_user FOREIGN KEY (user_id) REFERENCES USERS(id)
            )
        """)
        print("‚úÖ ANALYSIS_RESULTS tablosu olu≈üturuldu.")
    except Exception as e:
        if "ORA-00955" in str(e):
            print("‚ÑπÔ∏è ANALYSIS_RESULTS tablosu zaten var.")
        else:
            print(f"‚ùå ANALYSIS Hatasƒ±: {e}")

    cursor.close()
    conn.close()
    print("üöÄ Veritabanƒ± kurulumu tamamlandƒ±!")

if __name__ == "__main__":
    create_tables()