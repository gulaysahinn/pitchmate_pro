import oracledb
import os
import sys

# Dosyayƒ± direkt √ßalƒ±≈ütƒ±rdƒ±ƒüƒ±nda "ModuleNotFoundError" almamak i√ßin
# √ºst dizini Python yoluna ekliyoruz.
current_dir = os.path.dirname(os.path.abspath(__file__))
parent_dir = os.path.dirname(current_dir)
sys.path.append(parent_dir)

try:
    # app klas√∂r√º i√ßindeyse
    from app.database.oracle_client import get_db_connection
except ImportError:
    # database klas√∂r√º direkt backend altƒ±ndaysa
    from oracle_client import get_db_connection

def create_tables():
    conn = get_db_connection()
    if not conn:
        print("‚ùå Veritabanƒ±na baƒülanƒ±lamadƒ±, i≈ülem iptal.")
        return

    cursor = conn.cursor()
    print("üî® Tablolar g√ºncelleniyor/olu≈üturuluyor...")

    # --- 1. USERS TABLOSU ---
    # G√ºncelleme: email ve avatar s√ºtunlarƒ± eklendi
    try:
        cursor.execute("""
            CREATE TABLE USERS (
                id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                username VARCHAR2(50) NOT NULL UNIQUE,
                email VARCHAR2(100) UNIQUE,
                password_hash VARCHAR2(255) NOT NULL,
                avatar VARCHAR2(255),
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        """)
        print("‚úÖ USERS tablosu olu≈üturuldu.")
    except Exception as e:
        if "ORA-00955" in str(e):
            print("‚ÑπÔ∏è USERS tablosu zaten var.")
        else:
            print(f"‚ùå USERS Hatasƒ±: {e}")

    # --- 2. PROJECTS TABLOSU (YENƒ∞) ---
    try:
        cursor.execute("""
            CREATE TABLE PROJECTS (
                id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                user_id NUMBER NOT NULL,
                title VARCHAR2(150) NOT NULL,
                description VARCHAR2(500),
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                CONSTRAINT fk_projects_user FOREIGN KEY (user_id) REFERENCES USERS(id) ON DELETE CASCADE
            )
        """)
        print("‚úÖ PROJECTS tablosu olu≈üturuldu.")
    except Exception as e:
        if "ORA-00955" in str(e):
            print("‚ÑπÔ∏è PROJECTS tablosu zaten var.")
        else:
            print(f"‚ùå PROJECTS Hatasƒ±: {e}")

    # --- 3. PRESENTATIONS TABLOSU ---
    # G√ºncelleme: ANALYSIS_RESULTS yerine PRESENTATIONS ismini kullandƒ±k (Backend ile uyumlu)
    # G√ºncelleme: project_id eklendi
    try:
        cursor.execute("""
            CREATE TABLE PRESENTATIONS (
                id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                user_id NUMBER NOT NULL,
                project_id NUMBER,
                video_filename VARCHAR2(255),
                overall_score FLOAT DEFAULT 0,
                wpm FLOAT DEFAULT 0,
                filler_count NUMBER DEFAULT 0,
                filler_breakdown CLOB,
                monotony_score FLOAT DEFAULT 0,
                eye_contact_score FLOAT DEFAULT 0,
                body_language_score FLOAT DEFAULT 0,
                ai_feedback CLOB,
                analysis_json CLOB,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                
                CONSTRAINT fk_pres_user FOREIGN KEY (user_id) REFERENCES USERS(id) ON DELETE CASCADE,
                CONSTRAINT fk_pres_project FOREIGN KEY (project_id) REFERENCES PROJECTS(id) ON DELETE CASCADE
            )
        """)
        print("‚úÖ PRESENTATIONS tablosu olu≈üturuldu.")
    except Exception as e:
        if "ORA-00955" in str(e):
            print("‚ÑπÔ∏è PRESENTATIONS tablosu zaten var.")
            
            # Eƒüer tablo varsa ama project_id yoksa, sonradan eklemeye √ßalƒ±≈ü (Migration mantƒ±ƒüƒ±)
            try:
                cursor.execute("ALTER TABLE PRESENTATIONS ADD project_id NUMBER")
                print("   ‚îî‚îÄ‚îÄ project_id s√ºtunu eklendi.")
                cursor.execute("ALTER TABLE PRESENTATIONS ADD CONSTRAINT fk_pres_project FOREIGN KEY (project_id) REFERENCES PROJECTS(id) ON DELETE CASCADE")
                print("   ‚îî‚îÄ‚îÄ Foreign Key eklendi.")
            except Exception as alter_e:
                pass # S√ºtun zaten varsa hata verir, ge√ßiyoruz.

        else:
            print(f"‚ùå PRESENTATIONS Hatasƒ±: {e}")

    cursor.close()
    conn.close()
    print("üöÄ Veritabanƒ± ≈üemasƒ± ba≈üarƒ±yla hazƒ±rlandƒ±!")

if __name__ == "__main__":
    create_tables()